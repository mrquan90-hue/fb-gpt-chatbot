<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒê·∫∑t h√†ng - {{ product_name[:30] }}...</title>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <style>
        /* Critical CSS - Load ngay */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1DB954 0%, #17a74d 100%);
            padding: 20px;
            text-align: center;
            color: white;
        }
        
        .header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .content {
            padding: 20px;
        }
        
        .product-section {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .product-image-container {
            width: 120px;
            height: 120px;
            flex-shrink: 0;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
            position: relative;
        }
        
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s ease;
        }
        
        .product-image.loading {
            opacity: 0.3;
        }
        
        .product-info {
            flex: 1;
            min-width: 0;
        }
        
        .product-code {
            font-size: 12px;
            color: #666;
            background: #f5f5f5;
            padding: 6px 10px;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }
        
        .product-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 8px 0;
            line-height: 1.4;
            color: #222;
            word-break: break-word;
        }
        
        .product-price {
            color: #FF3B30;
            font-size: 18px;
            font-weight: 700;
            margin-top: 10px;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #444;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            background: white;
            font-family: inherit;
        }
        
        .select2-container {
            width: 100% !important;
        }
        
        .address-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .total-section {
            background: #f8f9fa;
            padding: 18px;
            border-radius: 12px;
            margin: 25px 0;
            text-align: center;
        }
        
        .total-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .total-amount {
            font-size: 24px;
            font-weight: 700;
            color: #FF3B30;
        }
        
        .submit-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, #1DB954 0%, #17a74d 100%);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            font-family: inherit;
        }
        
        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .note {
            margin-top: 15px;
            font-size: 12px;
            color: #888;
            text-align: center;
            line-height: 1.5;
        }
        
        @media (max-width: 480px) {
            .container {
                border-radius: 15px;
            }
            
            .content {
                padding: 15px;
            }
            
            .product-section {
                flex-direction: column;
            }
            
            .product-image-container {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>ƒê·∫∂T H√ÄNG - {{ current_fanpage_name }}</h2>
        </div>
        
        <div class="content">
            <!-- Product Info Section -->
            <div class="product-section">
                <div class="product-image-container">
                    <img id="product-image" class="product-image" 
                         src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjYwIiB5PSI2MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjY2NjY2NjIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+TG9hZGluZy4uLjwvdGV4dD48L3N2Zz4=" 
                         data-src="{{ default_image }}" 
                         alt="{{ product_name }}"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2UzZTNlMyIvPjx0ZXh0IHg9IjYwIiB5PSI2MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjOTk5OTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+'"
                         loading="lazy">
                </div>
                <div class="product-info">
                    <div class="product-code">M√£: {{ ms }}</div>
                    <h3 class="product-title">{{ product_name }}</h3>
                    <div class="product-price">
                        <span id="price-display">{{ price_int|format_number }} ƒë</span>
                    </div>
                </div>
            </div>

            <!-- Order Form -->
            <form id="orderForm">
                <!-- Color Selection -->
                <div class="form-group">
                    <label for="color">M√†u s·∫Øc:</label>
                    <select id="color" class="form-control">
                        {% for color in colors %}
                        <option value="{{ color }}">{{ color }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Size Selection -->
                <div class="form-group">
                    <label for="size">Size:</label>
                    <select id="size" class="form-control">
                        {% for size in sizes %}
                        <option value="{{ size }}">{{ size }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Quantity -->
                <div class="form-group">
                    <label for="quantity">S·ªë l∆∞·ª£ng:</label>
                    <input type="number" id="quantity" class="form-control" value="1" min="1">
                </div>

                <!-- Total Price -->
                <div class="total-section">
                    <div class="total-label">T·∫°m t√≠nh:</div>
                    <div class="total-amount" id="total-display">{{ price_int|format_number }} ƒë</div>
                </div>

                <!-- Customer Information -->
                <div class="form-group">
                    <label for="customerName">H·ªç v√† t√™n:</label>
                    <input type="text" id="customerName" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                    <input type="tel" id="phone" class="form-control" required>
                </div>

                <!-- Address Section - S·ª≠ d·ª•ng static list cho nhanh -->
                <div class="form-group">
                    <label for="province">T·ªânh/Th√†nh ph·ªë:</label>
                    <select id="province" class="form-control" required>
                        <option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>
                        <option value="H√† N·ªôi">H√† N·ªôi</option>
                        <option value="TP H·ªì Ch√≠ Minh">TP H·ªì Ch√≠ Minh</option>
                        <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                        <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
                        <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                        <option value="An Giang">An Giang</option>
                        <option value="B√† R·ªãa - V≈©ng T√†u">B√† R·ªãa - V≈©ng T√†u</option>
                        <option value="B·∫Øc Giang">B·∫Øc Giang</option>
                        <option value="B·∫Øc K·∫°n">B·∫Øc K·∫°n</option>
                        <option value="B·∫°c Li√™u">B·∫°c Li√™u</option>
                        <option value="B·∫Øc Ninh">B·∫Øc Ninh</option>
                        <option value="B·∫øn Tre">B·∫øn Tre</option>
                        <option value="B√¨nh ƒê·ªãnh">B√¨nh ƒê·ªãnh</option>
                        <option value="B√¨nh D∆∞∆°ng">B√¨nh D∆∞∆°ng</option>
                        <option value="B√¨nh Ph∆∞·ªõc">B√¨nh Ph∆∞·ªõc</option>
                        <option value="B√¨nh Thu·∫≠n">B√¨nh Thu·∫≠n</option>
                        <option value="C√† Mau">C√† Mau</option>
                        <option value="Cao B·∫±ng">Cao B·∫±ng</option>
                        <option value="ƒê·∫Øk L·∫Øk">ƒê·∫Øk L·∫Øk</option>
                        <option value="ƒê·∫Øk N√¥ng">ƒê·∫Øk N√¥ng</option>
                        <option value="ƒêi·ªán Bi√™n">ƒêi·ªán Bi√™n</option>
                        <option value="ƒê·ªìng Nai">ƒê·ªìng Nai</option>
                        <option value="ƒê·ªìng Th√°p">ƒê·ªìng Th√°p</option>
                        <option value="Gia Lai">Gia Lai</option>
                        <option value="H√† Giang">H√† Giang</option>
                        <option value="H√† Nam">H√† Nam</option>
                        <option value="H√† Tƒ©nh">H√† Tƒ©nh</option>
                        <option value="H·∫£i D∆∞∆°ng">H·∫£i D∆∞∆°ng</option>
                        <option value="H·∫≠u Giang">H·∫≠u Giang</option>
                        <option value="H√≤a B√¨nh">H√≤a B√¨nh</option>
                        <option value="H∆∞ng Y√™n">H∆∞ng Y√™n</option>
                        <option value="Kh√°nh H√≤a">Kh√°nh H√≤a</option>
                        <option value="Ki√™n Giang">Ki√™n Giang</option>
                        <option value="Kon Tum">Kon Tum</option>
                        <option value="Lai Ch√¢u">Lai Ch√¢u</option>
                        <option value="L√¢m ƒê·ªìng">L√¢m ƒê·ªìng</option>
                        <option value="L·∫°ng S∆°n">L·∫°ng S∆°n</option>
                        <option value="L√†o Cai">L√†o Cai</option>
                        <option value="Long An">Long An</option>
                        <option value="Nam ƒê·ªãnh">Nam ƒê·ªãnh</option>
                        <option value="Ngh·ªá An">Ngh·ªá An</option>
                        <option value="Ninh B√¨nh">Ninh B√¨nh</option>
                        <option value="Ninh Thu·∫≠n">Ninh Thu·∫≠n</option>
                        <option value="Ph√∫ Th·ªç">Ph√∫ Th·ªç</option>
                        <option value="Qu·∫£ng B√¨nh">Qu·∫£ng B√¨nh</option>
                        <option value="Qu·∫£ng Nam">Qu·∫£ng Nam</option>
                        <option value="Qu·∫£ng Ng√£i">Qu·∫£ng Ng√£i</option>
                        <option value="Qu·∫£ng Ninh">Qu·∫£ng Ninh</option>
                        <option value="Qu·∫£ng Tr·ªã">Qu·∫£ng Tr·ªã</option>
                        <option value="S√≥c TrƒÉng">S√≥c TrƒÉng</option>
                        <option value="S∆°n La">S∆°n La</option>
                        <option value="T√¢y Ninh">T√¢y Ninh</option>
                        <option value="Th√°i B√¨nh">Th√°i B√¨nh</option>
                        <option value="Th√°i Nguy√™n">Th√°i Nguy√™n</option>
                        <option value="Thanh H√≥a">Thanh H√≥a</option>
                        <option value="Th·ª´a Thi√™n Hu·∫ø">Th·ª´a Thi√™n Hu·∫ø</option>
                        <option value="Ti·ªÅn Giang">Ti·ªÅn Giang</option>
                        <option value="Tr√† Vinh">Tr√† Vinh</option>
                        <option value="Tuy√™n Quang">Tuy√™n Quang</option>
                        <option value="Vƒ©nh Long">Vƒ©nh Long</option>
                        <option value="Vƒ©nh Ph√∫c">Vƒ©nh Ph√∫c</option>
                        <option value="Y√™n B√°i">Y√™n B√°i</option>
                        <option value="Ph√∫ Y√™n">Ph√∫ Y√™n</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="district">Qu·∫≠n/Huy·ªán:</label>
                    <input type="text" id="district" class="form-control" placeholder="Nh·∫≠p qu·∫≠n/huy·ªán" required>
                </div>

                <div class="form-group">
                    <label for="ward">Ph∆∞·ªùng/X√£:</label>
                    <input type="text" id="ward" class="form-control" placeholder="Nh·∫≠p ph∆∞·ªùng/x√£" required>
                </div>

                <div class="form-group">
                    <label for="addressDetail">ƒê·ªãa ch·ªâ chi ti·∫øt:</label>
                    <input type="text" id="addressDetail" class="form-control" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, th√¥n/x√≥m..." required>
                </div>

                <!-- Submit Button -->
                <button type="button" id="submitBtn" class="submit-btn">
                    ƒê·∫∂T H√ÄNG NGAY
                </button>

                <p class="note">
                    Shop s·∫Ω g·ªçi x√°c nh·∫≠n trong 5-10 ph√∫t. Thanh to√°n khi nh·∫≠n h√†ng (COD).
                </p>
            </form>
        </div>
    </div>

    <!-- Defer loading of non-critical JS -->
    <script>
        // Inline critical JS ƒë·ªÉ form ho·∫°t ƒë·ªông ngay
        document.addEventListener('DOMContentLoaded', function() {
            const DOMAIN = '{{ domain }}';
            const API_BASE_URL = '/api';
            let BASE_PRICE = {{ price_int }};
            
            // Format price function
            function formatPrice(n) {
                return new Intl.NumberFormat('vi-VN').format(n) + ' ƒë';
            }
            
            // Update price display
            function updatePriceDisplay() {
                const quantity = parseInt(document.getElementById('quantity').value) || 1;
                const total = BASE_PRICE * quantity;
                document.getElementById('total-display').textContent = formatPrice(total);
            }
            
            // Load product image after page loads
            function loadProductImage() {
                const img = document.getElementById('product-image');
                if (img.dataset.src) {
                    // Create a new image to check if it loads
                    const tempImg = new Image();
                    tempImg.onload = function() {
                        img.src = this.src;
                        img.classList.remove('loading');
                    };
                    tempImg.onerror = function() {
                        // Use fallback image
                        img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2UzZTNlMyIvPjx0ZXh0IHg9IjYwIiB5PSI2MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjOTk5OTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+';
                    };
                    tempImg.src = img.dataset.src;
                }
            }
            
            // Get variant info (·∫£nh v√† gi√°)
            async function getVariantInfo(color, size) {
                try {
                    const response = await fetch(`${API_BASE_URL}/get-variant-info?ms={{ ms }}&color=${encodeURIComponent(color)}&size=${encodeURIComponent(size)}`);
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (error) {
                    console.log('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin bi·∫øn th·ªÉ, s·ª≠ d·ª•ng gi√° m·∫∑c ƒë·ªãnh');
                }
                return null;
            }
            
            // Update variant info when color/size changes
            async function updateVariantInfo() {
                const color = document.getElementById('color').value;
                const size = document.getElementById('size').value;
                
                const variantInfo = await getVariantInfo(color, size);
                if (variantInfo) {
                    // Update image
                    const img = document.getElementById('product-image');
                    if (variantInfo.image) {
                        const tempImg = new Image();
                        tempImg.onload = function() {
                            img.src = variantInfo.image;
                        };
                        tempImg.src = variantInfo.image;
                    }
                    
                    // Update price
                    if (variantInfo.price && variantInfo.price > 0) {
                        BASE_PRICE = variantInfo.price;
                        document.getElementById('price-display').textContent = formatPrice(BASE_PRICE);
                        updatePriceDisplay();
                    }
                }
            }
            
            // Submit order
            async function submitOrder() {
                const formData = {
                    ms: '{{ ms }}',
                    uid: '{{ uid }}',
                    color: document.getElementById('color').value,
                    size: document.getElementById('size').value,
                    quantity: parseInt(document.getElementById('quantity').value) || 1,
                    customerName: document.getElementById('customerName').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    province: document.getElementById('province').value,
                    district: document.getElementById('district').value.trim(),
                    ward: document.getElementById('ward').value.trim(),
                    addressDetail: document.getElementById('addressDetail').value.trim()
                };
                
                // Validation
                if (!formData.customerName) {
                    alert('Vui l√≤ng nh·∫≠p h·ªç v√† t√™n');
                    return;
                }
                
                if (!formData.phone) {
                    alert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i');
                    return;
                }
                
                // Phone validation
                const phoneRegex = /^(0[0-9]{9}|84[0-9]{9}|\+84[0-9]{9})$/;
                const normalizedPhone = formData.phone.replace(/\s/g, '');
                
                if (!phoneRegex.test(normalizedPhone)) {
                    alert('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë 10 ch·ªØ s·ªë (VD: 0982155980)');
                    return;
                }
                
                formData.phone = normalizedPhone.replace('+84', '0').replace(/^84/, '0');
                
                if (!formData.province) {
                    alert('Vui l√≤ng ch·ªçn t·ªânh/th√†nh ph·ªë');
                    return;
                }
                
                if (!formData.district) {
                    alert('Vui l√≤ng nh·∫≠p qu·∫≠n/huy·ªán');
                    return;
                }
                
                if (!formData.ward) {
                    alert('Vui l√≤ng nh·∫≠p ph∆∞·ªùng/x√£');
                    return;
                }
                
                if (!formData.addressDetail) {
                    alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ chi ti·∫øt');
                    return;
                }
                
                formData.fullAddress = `${formData.addressDetail}, ${formData.ward}, ${formData.district}, ${formData.province}`;
                formData.unitPrice = BASE_PRICE;
                formData.totalPrice = BASE_PRICE * formData.quantity;
                
                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> ƒêANG X·ª¨ L√ù...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/submit-order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        const successMessage = `üéâ ƒê√É ƒê·∫∂T H√ÄNG TH√ÄNH C√îNG!
                        
üì¶ M√£ s·∫£n ph·∫©m: {{ ms }}
üë§ Kh√°ch h√†ng: ${formData.customerName}
üì± SƒêT: ${formData.phone}
üìç ƒê·ªãa ch·ªâ: ${formData.fullAddress}
üí∞ ƒê∆°n gi√°: ${BASE_PRICE.toLocaleString('vi-VN')} ƒë
üì¶ S·ªë l∆∞·ª£ng: ${formData.quantity}
üí∞ T·ªïng ti·ªÅn: ${formData.totalPrice.toLocaleString('vi-VN')} ƒë

‚è∞ Shop s·∫Ω li√™n h·ªá x√°c nh·∫≠n trong 5-10 ph√∫t.
üöö Giao h√†ng b·ªüi ViettelPost (COD)

C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ ƒë·∫∑t h√†ng! ‚ù§Ô∏è`;
                        
                        alert(successMessage);
                        
                        // Reset form after 1 second
                        setTimeout(() => {
                            document.getElementById('orderForm').reset();
                            updatePriceDisplay();
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        }, 1000);
                        
                    } else {
                        alert('‚ùå ' + (data.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau'));
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('L·ªói khi ƒë·∫∑t h√†ng:', error);
                    alert('‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i!');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }
            
            // Initialize event listeners
            function initialize() {
                // Load image
                loadProductImage();
                
                // Update price when quantity changes
                document.getElementById('quantity').addEventListener('input', updatePriceDisplay);
                
                // Update variant info when color/size changes
                document.getElementById('color').addEventListener('change', updateVariantInfo);
                document.getElementById('size').addEventListener('change', updateVariantInfo);
                
                // Submit button
                document.getElementById('submitBtn').addEventListener('click', submitOrder);
                
                // Auto-focus on name field
                setTimeout(() => {
                    document.getElementById('customerName').focus();
                }, 500);
            }
            
            // Initialize when page loads
            initialize();
        });
    </script>
</body>
</html>
