// Function to load provinces from API
async function loadProvinces() {
    const provinceSelect = document.getElementById('province');
    
    try {
        provinceSelect.innerHTML = '<option value="">Đang tải tỉnh/thành...</option>';
        provinceSelect.disabled = true;
        
        const response = await fetch('/api/get-vietnam-address');
        const data = await response.json();
        
        if (data.success && data.data.provinces) {
            const provinces = data.data.provinces.sort((a, b) => 
                a.name.localeCompare(b.name, 'vi')
            );
            
            provinceSelect.innerHTML = '<option value="">Chọn Tỉnh/Thành phố</option>';
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province.code;
                option.textContent = province.name;
                provinceSelect.appendChild(option);
            });
            
            console.log(`✅ Đã tải ${provinces.length} tỉnh/thành phố từ API`);
        } else {
            throw new Error(data.message || 'Không thể tải dữ liệu tỉnh/thành');
        }
        
    } catch (error) {
        console.error('❌ Lỗi khi load tỉnh/thành:', error);
        provinceSelect.innerHTML = '<option value="">Lỗi tải dữ liệu</option>';
    } finally {
        provinceSelect.disabled = false;
    }
}

// Function to load districts based on selected province
async function loadDistricts(provinceCode) {
    const districtSelect = document.getElementById('district');
    const wardSelect = document.getElementById('ward');
    
    if (!provinceCode) {
        districtSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
        wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
        districtSelect.disabled = true;
        wardSelect.disabled = true;
        return;
    }
    
    try {
        districtSelect.innerHTML = '<option value="">Đang tải quận/huyện...</option>';
        districtSelect.disabled = true;
        wardSelect.disabled = true;
        
        const response = await fetch(`/api/get-districts?province_code=${provinceCode}`);
        const data = await response.json();
        
        if (data.success && data.data.districts) {
            const districts = data.data.districts.sort((a, b) => 
                a.name.localeCompare(b.name, 'vi')
            );
            
            districtSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district.code;
                option.textContent = district.name;
                districtSelect.appendChild(option);
            });
            
            console.log(`✅ Đã tải ${districts.length} quận/huyện`);
            districtSelect.disabled = false;
        } else {
            throw new Error(data.message || 'Không thể tải dữ liệu quận/huyện');
        }
        
    } catch (error) {
        console.error('❌ Lỗi khi load quận/huyện:', error);
        districtSelect.innerHTML = '<option value="">Lỗi tải dữ liệu</option>';
    }
}

// Function to load wards based on selected district
async function loadWards(districtCode) {
    const wardSelect = document.getElementById('ward');
    
    if (!districtCode) {
        wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
        wardSelect.disabled = true;
        return;
    }
    
    try {
        wardSelect.innerHTML = '<option value="">Đang tải phường/xã...</option>';
        wardSelect.disabled = true;
        
        const response = await fetch(`/api/get-wards?district_code=${districtCode}`);
        const data = await response.json();
        
        if (data.success && data.data.wards) {
            const wards = data.data.wards.sort((a, b) => 
                a.name.localeCompare(b.name, 'vi')
            );
            
            wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
            wards.forEach(ward => {
                const option = document.createElement('option');
                option.value = ward.code;
                option.textContent = ward.name;
                wardSelect.appendChild(option);
            });
            
            console.log(`✅ Đã tải ${wards.length} phường/xã`);
            wardSelect.disabled = false;
        } else {
            throw new Error(data.message || 'Không thể tải dữ liệu phường/xã');
        }
        
    } catch (error) {
        console.error('❌ Lỗi khi load phường/xã:', error);
        wardSelect.innerHTML = '<option value="">Lỗi tải dữ liệu</option>';
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const provinceSelect = document.getElementById('province');
    const districtSelect = document.getElementById('district');
    const wardSelect = document.getElementById('ward');
    
    // Load provinces on page load
    loadProvinces();
    
    // Province change event
    provinceSelect.addEventListener('change', function() {
        const provinceCode = this.value;
        const provinceName = this.options[this.selectedIndex]?.text || '';
        
        document.getElementById('provinceName').value = provinceName;
        loadDistricts(provinceCode);
        
        // Clear wards
        wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
        wardSelect.disabled = true;
    });
    
    // District change event
    districtSelect.addEventListener('change', function() {
        const districtCode = this.value;
        const districtName = this.options[this.selectedIndex]?.text || '';
        
        document.getElementById('districtName').value = districtName;
        loadWards(districtCode);
    });
    
    // Ward change event
    wardSelect.addEventListener('change', function() {
        const wardName = this.options[this.selectedIndex]?.text || '';
        document.getElementById('wardName').value = wardName;
    });
    
    // Address detail change event
    const addressDetail = document.getElementById('addressDetail');
    if (addressDetail) {
        addressDetail.addEventListener('input', updateFullAddress);
    }
});

// Function to update full address preview
function updateFullAddress() {
    const provinceText = document.getElementById('province').options[document.getElementById('province').selectedIndex]?.text || '';
    const districtText = document.getElementById('district').options[document.getElementById('district').selectedIndex]?.text || '';
    const wardText = document.getElementById('ward').options[document.getElementById('ward').selectedIndex]?.text || '';
    const detailText = document.getElementById('addressDetail').value || '';
    
    // Build full address
    const fullAddress = [detailText, wardText, districtText, provinceText]
        .filter(part => part.trim() !== '')
        .join(', ');
    
    document.getElementById('fullAddress').value = fullAddress;
    
    // Update preview
    const previewElement = document.getElementById('addressPreview');
    if (previewElement && fullAddress.trim()) {
        previewElement.innerHTML = `
            <div class="address-preview-content">
                <strong>Địa chỉ nhận hàng:</strong>
                <p>${fullAddress}</p>
            </div>
        `;
        previewElement.style.display = 'block';
    }
}
